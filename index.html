<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTÃO CONCENAL V10.2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        school: { green: '#047857', lightGreen: '#10B981', red: '#DC2626', bg: '#F3F4F6' }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F3F4F6; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #10B981; box-shadow: 0 0 5px #10B981; }
        
        @media print {
            body * { visibility: hidden; }
            #modal-report, #modal-report * { visibility: visible; }
            #modal-report { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 0; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="fixed inset-0 z-[60] flex items-center justify-center bg-gray-900 text-white hidden">
        <div class="bg-gray-800 p-8 rounded-lg max-w-lg w-full text-center">
            <h2 class="text-2xl font-bold mb-4 text-yellow-400">Configuração Necessária</h2>
            <p class="text-xs mb-4">Cole sua configuração do Firebase no código.</p>
            <button onclick="location.reload()" class="bg-blue-600 px-6 py-2 rounded hover:bg-blue-500">Recarregar</button>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-school-green">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md mx-4 fade-in relative">
            <div class="text-center mb-6">
                <i class="fas fa-school text-5xl text-school-green mb-3"></i>
                <h1 class="text-xl font-bold text-gray-800 leading-tight">CONTEMPORÂNEO<br>CENTRO EDUCACIONAL</h1>
                <p class="text-gray-500 text-sm mt-2">Portal Acadêmico</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Usuário</label>
                    <input type="text" id="username" class="block w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-school-green outline-none" placeholder="Ex: admin" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Senha</label>
                    <input type="password" id="password" class="block w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-school-green outline-none" required>
                </div>
                <div id="login-error" class="text-red-600 text-sm hidden bg-red-50 p-2 rounded border border-red-200 text-center">
                    <i class="fas fa-exclamation-circle"></i> Credenciais inválidas.
                </div>
                <button type="submit" id="btn-login" class="w-full py-2.5 bg-school-green text-white rounded hover:bg-green-700 font-bold transition shadow-lg flex justify-center items-center gap-2">
                    <span>Entrar</span>
                </button>
            </form>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-screen" class="hidden flex-col h-full relative">
        <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-80 z-40 flex items-center justify-center hidden">
            <i class="fas fa-circle-notch fa-spin text-4xl text-school-green"></i>
        </div>

        <!-- Header -->
        <header class="bg-school-green text-white shadow-md z-20 shrink-0">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-graduation-cap text-2xl"></i>
                    <div class="leading-tight">
                        <h1 class="text-sm font-bold tracking-wide uppercase">CONCENAL</h1>
                        <span class="text-xs text-green-200 block truncate max-w-[150px] sm:max-w-xs" id="user-display-name">...</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 overflow-x-auto no-scrollbar">
                    <!-- Menu Admin -->
                    <button onclick="openUsersModal()" id="btn-manage-users" class="hidden bg-green-800 hover:bg-green-900 text-white px-3 py-1.5 rounded text-xs font-bold items-center gap-2 border border-green-700 whitespace-nowrap">
                        <i class="fas fa-users-cog"></i> <span class="hidden sm:inline">Gestão</span>
                    </button>

                    <!-- Navegação Central -->
                    <div class="flex bg-green-800 rounded p-1" id="main-nav">
                        <button onclick="switchMode('grades')" id="nav-grades" class="px-3 py-1 rounded text-xs sm:text-sm font-bold bg-white text-school-green shadow">Notas</button>
                        <button onclick="switchMode('attendance')" id="nav-attendance" class="px-3 py-1 rounded text-xs sm:text-sm font-bold text-green-100 hover:text-white">Freq.</button>
                        <button onclick="switchMode('daily')" id="nav-daily" class="px-3 py-1 rounded text-xs sm:text-sm font-bold text-green-100 hover:text-white">Diário</button>
                        <!-- BOTÃO DE IA -->
                        <button onclick="switchMode('ai-tools')" id="nav-ai-tools" class="px-3 py-1 rounded text-xs sm:text-sm font-bold text-green-100 hover:text-white flex items-center gap-1"><i class="fas fa-robot"></i> <span class="hidden sm:inline">IA</span></button>
                    </div>
                    
                    <button onclick="logout()" class="text-white hover:text-red-200 ml-2"><i class="fas fa-sign-out-alt fa-lg"></i></button>
                </div>
            </div>
        </header>

        <!-- Barra de Controle (Some para Pais) -->
        <div id="control-bar" class="bg-white border-b border-gray-200 shadow-sm shrink-0 z-10">
            <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row gap-4 justify-between items-center">
                <div class="flex flex-wrap items-center gap-3 w-full md:w-auto justify-center md:justify-start">
                    <select id="subject-select" onchange="changeSubject(this.value)" class="bg-green-50 border border-green-200 text-green-800 font-bold py-2 px-3 rounded text-sm focus:outline-none cursor-pointer"></select>
                    <div class="flex space-x-1 overflow-x-auto" id="class-tabs"></div>
                </div>
                <div id="action-buttons" class="flex gap-2"></div>
            </div>
        </div>

        <!-- Conteúdo -->
        <main class="flex-1 overflow-auto bg-gray-50 p-2 md:p-6" id="main-content">
            
            <!-- Visão: Notas -->
            <div id="view-grades" class="max-w-7xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden fade-in border border-gray-200">
                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-sm font-bold text-gray-600 uppercase" id="grades-title">Boletim Escolar</h2>
                    <span class="text-xs text-green-600 font-bold flex items-center gap-1"><i class="fas fa-cloud-upload-alt"></i> Online</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100 text-gray-500 font-bold text-xs uppercase text-center sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 text-left w-48 sticky left-0 bg-gray-100 shadow-sm border-r">Aluno</th>
                                <th class="w-14">U1</th><th class="w-14">U2</th><th class="w-14">U3</th><th class="w-14">U4</th><th class="w-14">U5</th><th class="w-14">U6</th>
                                <th class="w-16 bg-blue-50 text-blue-700 border-l">Faltas</th>
                                <th class="w-16 bg-gray-50 text-gray-800 border-l">Média</th>
                                <th class="w-20 text-red-600 border-l">Rec</th>
                                <th class="w-24 border-l">Status</th>
                            </tr>
                        </thead>
                        <tbody id="grades-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
                <div id="empty-state" class="hidden p-12 text-center text-gray-500"><i class="fas fa-user-graduate text-4xl mb-3 text-gray-300"></i><p>Nenhum dado encontrado.</p></div>
            </div>

            <!-- Visão: Frequência -->
            <div id="view-attendance" class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden hidden fade-in border border-gray-200">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <div class="bg-white p-1 rounded border border-gray-200 shadow-sm">
                        <input type="date" id="attendance-date" class="block text-sm font-bold text-gray-800 focus:outline-none">
                    </div>
                    <div class="text-xs flex gap-2">
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-500"></div> P</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-red-500"></div> F</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-yellow-500"></div> Just.</span>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <tbody id="attendance-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end" id="attendance-actions">
                    <button onclick="saveDailyAttendance()" class="bg-school-green hover:bg-green-700 text-white px-6 py-2 rounded shadow font-bold text-sm">Salvar Chamada</button>
                </div>
                <div id="empty-state-attendance" class="hidden p-12 text-center text-gray-500">
                    <i class="fas fa-calendar-times text-4xl mb-3 text-gray-300"></i>
                    <p>Nenhum aluno nesta turma para esta data.</p>
                </div>
            </div>

            <!-- Visão: Diário -->
            <div id="view-daily" class="max-w-5xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden hidden fade-in border border-gray-200">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700 text-sm uppercase"><i class="fas fa-book-open mr-2"></i> Diário de Classe</h3>
                    <div class="bg-white p-1 rounded border border-gray-200 shadow-sm">
                        <input type="date" id="daily-date" class="block text-sm font-bold text-gray-800 focus:outline-none">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100 text-xs text-gray-500 uppercase font-bold text-center">
                            <tr>
                                <th class="px-4 py-3 text-left">Aluno</th>
                                <th class="px-2 py-3 w-32">Dever de Casa</th>
                                <th class="px-2 py-3 w-40">Comportamento</th>
                            </tr>
                        </thead>
                        <tbody id="daily-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end" id="daily-actions">
                    <button onclick="saveDailyLog()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded shadow font-bold text-sm">Salvar Diário</button>
                </div>
            </div>

            <!-- Visão Ferramentas IA -->
            <div id="view-ai-tools" class="max-w-4xl mx-auto hidden fade-in">
                
                <div id="global-ai-key-alert" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded shadow hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-key text-yellow-500 mr-2"></i>
                            <p class="text-sm text-yellow-700">Para usar IA, configure sua chave do Google Gemini.</p>
                        </div>
                        <button onclick="promptApiKey()" class="text-sm font-bold text-yellow-800 hover:underline">Configurar</button>
                    </div>
                </div>

                <!-- Painel Professor -->
                <div id="ai-panel-teacher" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-purple-600 p-4 text-white"><h3 class="font-bold">Plano de Aula</h3></div>
                        <div class="p-4 space-y-3">
                            <input id="ai-plan-topic" class="w-full border p-2 rounded text-sm" placeholder="Tema (ex: Frações)">
                            <button onclick="generateLessonPlan()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded font-bold">Gerar Plano</button>
                            <textarea id="ai-plan-output" rows="8" class="w-full border p-2 rounded text-xs bg-gray-50" placeholder="Resultado..."></textarea>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-indigo-600 p-4 text-white"><h3 class="font-bold">Criador de Provas</h3></div>
                        <div class="p-4 space-y-3">
                            <input id="ai-quiz-topic" class="w-full border p-2 rounded text-sm" placeholder="Assunto">
                            <button onclick="generateQuiz()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded font-bold">Criar Questões</button>
                            <textarea id="ai-quiz-output" rows="8" class="w-full border p-2 rounded text-xs bg-gray-50" placeholder="Resultado..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Painel Pais -->
                <div id="ai-panel-parent" class="hidden">
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden max-w-2xl mx-auto">
                        <div class="bg-green-600 p-4 text-white"><h3 class="font-bold">Tutor Virtual</h3></div>
                        <div class="p-6 space-y-4">
                            <textarea id="ai-tutor-prompt" rows="3" class="w-full border p-3 rounded text-sm" placeholder="Dúvida sobre a matéria..."></textarea>
                            <button onclick="generateTutorResponse()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded font-bold">Perguntar</button>
                            <div id="ai-tutor-output" class="bg-green-50 p-4 rounded border border-green-100 text-sm text-gray-800 hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAIS -->
    <!-- Justificar -->
    <div id="modal-justification" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[80] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
            <h3 class="font-bold text-lg mb-2 text-school-green">Justificar Falta</h3>
            <p class="text-xs text-gray-500 mb-4" id="just-date-display">--</p>
            <select id="just-reason" class="w-full border p-2 rounded text-sm mb-3">
                <option>Médico</option><option>Pessoal</option><option>Outro</option>
            </select>
            <label class="block text-xs font-bold text-gray-700 mb-1">Foto (Opcional)</label>
            <input type="file" id="just-file" accept="image/*" class="w-full text-xs border p-2 rounded mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-justification')" class="px-4 py-2 bg-gray-200 rounded text-sm">Cancelar</button>
                <button onclick="submitJustification()" class="px-4 py-2 bg-school-green text-white rounded text-sm font-bold">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Importar em Massa (NOVO) -->
    <div id="modal-import" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[80] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="font-bold text-lg mb-2 text-school-green">Importar Alunos</h3>
            <p class="text-xs text-gray-500 mb-2">Cole a lista de nomes (um por linha) para adicionar à turma atual.</p>
            <textarea id="import-list" rows="10" class="w-full border p-2 rounded text-sm mb-4" placeholder="Ana Silva&#10;Bruno Costa&#10;Carlos..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-import')" class="px-4 py-2 bg-gray-200 rounded text-sm">Cancelar</button>
                <button onclick="importStudents()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold">Importar</button>
            </div>
        </div>
    </div>

    <!-- Gestão de Usuários (Admin) -->
    <div id="modal-users" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[90] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h3 class="font-bold text-gray-800">Gestão de Acessos</h3>
                <button onclick="closeModal('modal-users')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto">
                <div class="flex gap-2 mb-4 border-b">
                    <button onclick="switchUserTab('teacher')" id="tab-teacher" class="px-3 py-1 font-bold text-sm border-b-2 border-school-green text-school-green">Professores</button>
                    <button onclick="switchUserTab('parent')" id="tab-parent" class="px-3 py-1 font-bold text-sm text-gray-500">Pais</button>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-100">
                    <div class="grid grid-cols-1 gap-2 mb-2">
                        <input type="text" id="new-u-name" placeholder="Nome" class="border p-2 rounded text-sm">
                        <input type="text" id="new-u-login" placeholder="Login" class="border p-2 rounded text-sm">
                        <input type="text" id="new-u-pass" placeholder="Senha" class="border p-2 rounded text-sm">
                        <div id="field-teacher-subj"><select id="new-u-subject" class="w-full border p-2 rounded text-sm"></select></div>
                        <div id="field-parent-student" class="hidden">
                            <input type="text" id="new-u-student-id" placeholder="ID do Aluno (Copie da lista de alunos)" class="border p-2 rounded text-sm w-full">
                            <p class="text-[10px] text-gray-500 mt-1">*Copie o ID que aparece abaixo do nome do aluno na tabela de Notas.</p>
                        </div>
                    </div>
                    <button onclick="createUser()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-sm font-bold">Criar Acesso</button>
                </div>
                <div id="users-list" class="space-y-2 text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Relatório Individual -->
    <div id="modal-report" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
        <div id="modal-report-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl flex flex-col">
            <div class="p-6 border-b flex justify-between items-start bg-gray-50 rounded-t-lg">
                <div>
                    <h2 class="text-xl font-bold text-gray-800" id="report-name">--</h2>
                    <p class="text-xs text-gray-500 mt-1">RELATÓRIO DE DESEMPENHO</p>
                </div>
                <button onclick="closeModal('modal-report')" class="text-gray-400 no-print"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                    <div class="bg-gray-100 p-2 rounded"><span class="text-xs block text-gray-500">Média</span><strong class="text-lg" id="report-avg">-</strong></div>
                    <div class="bg-gray-100 p-2 rounded"><span class="text-xs block text-gray-500">Faltas</span><strong class="text-lg" id="report-faults">-</strong></div>
                    <div class="bg-gray-100 p-2 rounded"><span class="text-xs block text-gray-500">Status</span><strong class="text-lg" id="report-status">-</strong></div>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-700">Análise Pedagógica</h4>
                        <!-- Botões só aparecem para Professor/Admin -->
                        <div id="report-tools" class="flex gap-2 no-print">
                            <button onclick="generateReportAnalysis()" class="bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold shadow flex items-center gap-1"><i class="fas fa-magic"></i> IA Gemini</button>
                            <button onclick="saveReportObservation()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold shadow flex items-center gap-1"><i class="fas fa-save"></i> Salvar Parecer</button>
                        </div>
                    </div>
                    <textarea id="report-observation" rows="6" class="w-full border border-gray-300 rounded p-3 text-sm focus:ring-2 focus:ring-school-green outline-none" placeholder="O professor ainda não adicionou uma análise."></textarea>
                    <div id="ai-loading" class="hidden text-center py-2 text-purple-600 text-xs font-bold"><i class="fas fa-spinner fa-spin"></i> Escrevendo relatório...</div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-lg flex justify-end no-print">
                <button onclick="window.print()" class="bg-gray-700 text-white px-4 py-2 rounded text-sm font-bold"><i class="fas fa-print"></i> Imprimir</button>
            </div>
        </div>
    </div>

    <!-- Modal Aux -->
    <div id="modal-add" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4"><div class="bg-white rounded p-6 w-full max-w-sm"><h3 class="font-bold mb-4">Adicionar Aluno</h3><input id="new-name" class="border w-full p-2 mb-4 rounded" placeholder="Nome"><div class="flex justify-end gap-2"><button onclick="closeModal('modal-add')" class="bg-gray-200 px-4 py-2 rounded">Cancelar</button><button onclick="addStudent()" class="bg-school-green text-white px-4 py-2 rounded">Salvar</button></div></div></div>

    <!-- Script Lógica -->
    <script>
        // ==========================================
        // CONFIGURAÇÃO DO FIREBASE (INSIRA AQUI)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCBZGHO9APpiZ-8Mgq3TDErFvKW62nnqH0",
            authDomain: "concenal-sistema.firebaseapp.com",
            projectId: "concenal-sistema",
            storageBucket: "concenal-sistema.firebasestorage.app",
            messagingSenderId: "825709353374",
            appId: "1:825709353374:web:1dd2657f60fb50b46c5e8f"
        };
        // ==========================================

        let db;
        let unsubscribe = null;
        let currentUser = null; 
        let currentStudentForReport = null;
        let currentJustificationDate = null;
        let currentJustificationStudentId = null;
        let creatingUserType = 'teacher';

        const today = new Date().toISOString().split('T')[0];
        const SUBJECTS = ["Matemática", "Português", "Geografia", "História", "Arte", "Educação Física", "Inglês", "Ciências"];
        
        let appData = {
            currentClass: "9A",
            currentSubject: "Matemática",
            currentMode: "grades", 
            classes: ["6A", "6B", "7A", "7B", "8A", "8B", "9A", "9B"],
            students: [] 
        };

        function init() {
            if (!firebaseConfig.apiKey) { document.getElementById('setup-screen').classList.remove('hidden'); return; }
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            db.enablePersistence().catch(err => console.log("Persistence error", err));

            const session = localStorage.getItem('concenal_v7_session');
            if(session) { currentUser = JSON.parse(session); showApp(); } 
            else { document.getElementById('login-screen').classList.remove('hidden'); }

            document.getElementById('attendance-date').value = today;
            document.getElementById('daily-date').value = today;
            populateSubjectSelect();
            populateNewUserSubjectSelect();
            
            document.getElementById('attendance-date').onchange = renderAttendanceTable;
            document.getElementById('daily-date').onchange = renderDailyLog;
            
            checkApiKey();
        }

        function checkApiKey() {
            if(!localStorage.getItem('gemini_api_key')) {
                document.getElementById('global-ai-key-alert').classList.remove('hidden');
            }
        }

        function promptApiKey() {
            const k = prompt("Insira sua Chave API do Google Gemini:");
            if(k) {
                localStorage.setItem('gemini_api_key', k.trim());
                document.getElementById('global-ai-key-alert').classList.add('hidden');
                alert("Chave salva!");
            }
        }

        // --- AUTH ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const btn = document.getElementById('btn-login');
            const err = document.getElementById('login-error');

            btn.disabled = true; btn.innerText = "Verificando..."; err.classList.add('hidden');

            try {
                if (u === "admin" && p === "1234") {
                    currentUser = { name: "Coordenação", role: "admin", subject: "all" };
                    finalizeLogin(); return;
                }
                const snap = await db.collection('concenal_users').where('username', '==', u).where('password', '==', p).limit(1).get();
                if (!snap.empty) {
                    const d = snap.docs[0].data();
                    currentUser = { name: d.name, role: d.role||'teacher', subject: d.subject||null, studentId: d.studentId||null };
                    finalizeLogin();
                } else { throw new Error(); }
            } catch (error) { err.classList.remove('hidden'); btn.disabled = false; btn.innerText = "Entrar"; }
        });

        function finalizeLogin() {
            localStorage.setItem('concenal_v7_session', JSON.stringify(currentUser));
            showApp();
        }

        function logout() { localStorage.removeItem('concenal_v7_session'); location.reload(); }

        // --- UI ---
        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = currentUser.name;

            const isParent = currentUser.role === 'parent';
            const isAdmin = currentUser.role === 'admin';

            if (isParent) {
                document.getElementById('control-bar').classList.add('hidden');
                document.getElementById('btn-manage-users').classList.add('hidden');
                document.getElementById('attendance-actions').classList.add('hidden');
                document.getElementById('daily-actions').classList.add('hidden');
                document.getElementById('nav-daily').innerText = "Diário";
                document.getElementById('ai-panel-teacher').classList.add('hidden');
                document.getElementById('ai-panel-parent').classList.remove('hidden');
            } else {
                document.getElementById('control-bar').classList.remove('hidden');
                document.getElementById('attendance-actions').classList.remove('hidden');
                document.getElementById('daily-actions').classList.remove('hidden');
                document.getElementById('ai-panel-teacher').classList.remove('hidden');
                document.getElementById('ai-panel-parent').classList.add('hidden');
            }

            if (isAdmin) {
                document.getElementById('btn-manage-users').classList.remove('hidden');
                document.getElementById('subject-select').disabled = false;
            } else if (!isParent) {
                document.getElementById('btn-manage-users').classList.add('hidden');
                appData.currentSubject = currentUser.subject;
                document.getElementById('subject-select').value = currentUser.subject;
                document.getElementById('subject-select').disabled = true;
            }
            startRealtimeSync();
        }

        function startRealtimeSync() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            let query = db.collection('concenal_students');
            unsubscribe = query.onSnapshot((snapshot) => {
                const students = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (currentUser.role === 'parent') {
                        if (doc.id === currentUser.studentId) {
                            students.push({ id: doc.id, ...data });
                            appData.currentClass = data.class; 
                        }
                    } else { students.push({ id: doc.id, ...data }); }
                });
                appData.students = students;
                updateUI();
                document.getElementById('loading-overlay').classList.add('hidden');
            });
        }

        function updateUI() {
            renderClassTabs();
            if(currentUser.role === 'parent') document.getElementById('class-tabs').innerHTML = '<span class="text-sm font-bold text-gray-500 p-2">Visualização do Responsável</span>';

            document.getElementById('view-grades').classList.add('hidden');
            document.getElementById('view-attendance').classList.add('hidden');
            document.getElementById('view-daily').classList.add('hidden');
            document.getElementById('view-ai-tools').classList.add('hidden');

            const resetBtns = () => {
                ['nav-grades','nav-attendance','nav-daily','nav-ai-tools'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.className = "px-3 py-1 rounded text-xs sm:text-sm font-bold text-green-100 hover:text-white flex items-center gap-1";
                });
            };
            resetBtns();
            const activeBtn = document.getElementById(`nav-${appData.currentMode}`);
            if(activeBtn) activeBtn.className = "px-3 py-1 rounded text-xs sm:text-sm font-bold bg-white text-school-green shadow flex items-center gap-1";

            if (appData.currentMode === 'grades') renderGradesTable();
            else if (appData.currentMode === 'attendance') renderAttendanceTable();
            else if (appData.currentMode === 'daily') renderDailyLog();
            else if (appData.currentMode === 'ai-tools') document.getElementById('view-ai-tools').classList.remove('hidden');
        }

        // --- GEMINI AI CALLS ---
        async function callGemini(prompt, outputId, loadingId = null) {
            const apiKey = localStorage.getItem('gemini_api_key');
            if(!apiKey) { promptApiKey(); return; }
            
            if(loadingId) document.getElementById(loadingId).classList.remove('hidden');
            const outEl = document.getElementById(outputId);
            if(outEl.tagName === 'DIV') outEl.innerHTML = "Gerando..."; else outEl.value = "Gerando...";

            const models = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-1.0-pro'];
            let resultText = "";
            let success = false;

            for (const model of models) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    if(data.candidates && data.candidates.length > 0) {
                        resultText = data.candidates[0].content.parts[0].text;
                        success = true;
                        break;
                    }
                } catch(e) { console.error(e); }
            }

            if(loadingId) document.getElementById(loadingId).classList.add('hidden');
            
            if(success) {
                if(outEl.tagName === 'DIV') outEl.innerHTML = resultText.replace(/\n/g, '<br>');
                else outEl.value = resultText;
            } else {
                alert("Erro ao conectar com a IA. Verifique sua chave.");
                if(outEl.tagName !== 'DIV') outEl.value = "Erro na geração.";
            }
        }

        function generateLessonPlan() {
            const topic = document.getElementById('ai-plan-topic').value;
            if(!topic) return alert("Digite o tema!");
            const prompt = `Crie um plano de aula sobre: ${topic}.`;
            callGemini(prompt, 'ai-plan-output');
        }

        function generateQuiz() {
            const topic = document.getElementById('ai-quiz-topic').value;
            if(!topic) return alert("Digite o assunto!");
            const prompt = `Crie 5 questões múltipla escolha sobre ${topic} com gabarito.`;
            callGemini(prompt, 'ai-quiz-output');
        }

        function generateTutorResponse() {
            const q = document.getElementById('ai-tutor-prompt').value;
            if(!q) return alert("Digite sua dúvida!");
            document.getElementById('ai-tutor-output').classList.remove('hidden');
            callGemini(`Explique para um aluno: ${q}`, 'ai-tutor-output'); 
        }

        function generateReportAnalysis() {
            const s = currentStudentForReport;
            const subData = ensureSubjectData(s, appData.currentSubject);
            const calc = calculateStatus(subData);
            const prompt = `Analise o aluno ${s.name} (${appData.currentSubject}). Notas: ${subData.units.join(', ')}. Média: ${calc.average}. Faltas: ${Object.values(subData.attendance).filter(x=>x==='F'||x.status==='F').length}. Escreva um parecer pedagógico curto.`;
            callGemini(prompt, 'report-observation', 'ai-loading');
        }

        // --- RENDER TABLES ---
        function renderGradesTable() {
            document.getElementById('view-grades').classList.remove('hidden');
            const canEdit = currentUser.role !== 'parent';
            let btns = '';
            if(canEdit) {
                btns += `<button onclick="openAddModal()" class="bg-school-green text-white px-3 py-2 rounded text-sm font-bold shadow mr-2"><i class="fas fa-plus"></i> Aluno</button>`;
                if(currentUser.role === 'admin') btns += `<button onclick="document.getElementById('modal-import').classList.remove('hidden')" class="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-file-import"></i> Importar Lista</button>`;
            }
            document.getElementById('action-buttons').innerHTML = btns;

            const tbody = document.getElementById('grades-body'); tbody.innerHTML = '';
            const students = getStudentsByClass();
            if (students.length === 0) { document.getElementById('empty-state').classList.remove('hidden'); return; }
            document.getElementById('empty-state').classList.add('hidden');

            let html = '';
            students.forEach(s => {
                const subData = ensureSubjectData(s, appData.currentSubject);
                const calc = calculateStatus(subData);
                const totalFaults = Object.values(subData.attendance || {}).filter(val => {
                    if (val === 'F') return true;
                    if (typeof val === 'object' && val.status === 'F' && !val.justified) return true;
                    return false;
                }).length;

                html += `<tr class="hover:bg-gray-50 border-b">
                    <td class="px-4 py-3 font-medium text-gray-900 border-r flex justify-between items-center group">
                        <div class="flex flex-col"><span>${s.name}</span>${canEdit ? `<span class="text-[10px] text-gray-400 select-all">ID: ${s.id}</span>` : ''}</div>
                        <div class="flex gap-2"><button onclick="openReportModal('${s.id}')" class="text-gray-400 hover:text-blue-600"><i class="fas fa-file-alt"></i></button>${canEdit ? `<button onclick="deleteStudent('${s.id}')" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>` : ''}</div>
                    </td>`;
                for(let i=0; i<6; i++) {
                    const val = subData.units[i] ?? '';
                    const color = (val !== '' && val < 6) ? 'text-red-600 font-bold' : 'text-green-700';
                    const disabled = !canEdit ? 'disabled' : '';
                    html += `<td class="px-1 border-l"><input type="number" step="0.1" ${disabled} class="w-full text-center bg-transparent focus:outline-none ${color}" value="${val}" onchange="updateGrade('${s.id}', ${i}, this.value)"></td>`;
                }
                html += `<td class="px-1 text-center font-bold text-blue-800 border-l cursor-pointer" onclick="showHistory('${s.id}')">${totalFaults}</td><td class="px-2 text-center font-bold border-l">${calc.average}</td><td class="px-1 border-l"><input type="number" step="0.1" ${!canEdit || calc.average >= 6 ? 'disabled' : ''} class="w-full text-center ${calc.average >= 6 ? 'bg-gray-100' : 'bg-red-50 text-red-700'}" value="${subData.recovery ?? ''}" onchange="updateRecovery('${s.id}', this.value)"></td><td class="px-2 text-center text-[10px] font-bold uppercase border-l ${calc.statusClass}">${calc.status}</td></tr>`;
            });
            tbody.innerHTML = html;
        }

        let tempAttendance = {};
        function renderAttendanceTable() {
            document.getElementById('view-attendance').classList.remove('hidden');
            document.getElementById('action-buttons').innerHTML = '';
            const tbody = document.getElementById('attendance-body'); tbody.innerHTML = '';
            const date = document.getElementById('attendance-date').value;
            const students = getStudentsByClass();
            tempAttendance = {};

            if (students.length === 0) {
                document.getElementById('empty-state-attendance').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state-attendance').classList.add('hidden');

            let html = '';
            students.forEach(s => {
                const subData = ensureSubjectData(s, appData.currentSubject);
                const record = subData.attendance[date]; 
                let status = 'P', isJustified = false, hasDoc = false;
                if (record) {
                    if (typeof record === 'string') { status = record; }
                    else { status = record.status; isJustified = record.justified; hasDoc = !!record.doc; }
                }
                tempAttendance[s.id] = record || 'P';
                let btnClass = status === 'P' ? "bg-green-100 text-green-800" : (isJustified ? "bg-blue-100 text-blue-800" : "bg-red-100 text-red-800");
                let btnText = status === 'P' ? "PRESENTE" : (isJustified ? "JUSTIFICADO" : "FALTOU");
                let attachBtn = (status==='F'||isJustified) ? (currentUser.role==='parent' ? `<button onclick="openJustifyModal('${s.id}')" class="ml-2 text-xs text-blue-500 underline">Justificar</button>` : (hasDoc ? `<button onclick="viewDoc('${s.id}', '${date}')" class="ml-2 text-xs text-blue-500"><i class="fas fa-paperclip"></i></button>` : '')) : '';

                html += `<tr><td class="px-6 py-4 font-bold text-gray-700 flex justify-between items-center">${s.name} ${attachBtn}</td><td class="px-6 py-4 text-center"><button id="btn-att-${s.id}" onclick="toggleAttendance('${s.id}')" ${currentUser.role==='parent'?'disabled':''} class="w-32 py-2 rounded shadow text-xs font-bold border ${btnClass}">${btnText}</button></td></tr>`;
            });
            tbody.innerHTML = html;
        }

        let tempDaily = {};
        function renderDailyLog() {
            document.getElementById('view-daily').classList.remove('hidden');
            const tbody = document.getElementById('daily-body'); tbody.innerHTML = '';
            const date = document.getElementById('daily-date').value;
            const students = getStudentsByClass();
            const canEdit = currentUser.role !== 'parent';

            let html = '';
            students.forEach(s => {
                const subData = ensureSubjectData(s, appData.currentSubject);
                const todayLog = (subData.dailyLogs || {})[date] || { homework: false, behavior: 'Normal' };
                tempDaily[s.id] = { ...todayLog };
                const hwClass = todayLog.homework ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-400';
                
                html += `<tr class="border-b"><td class="px-4 py-3 font-medium">${s.name}</td><td class="px-2 py-3 text-center"><button onclick="toggleHomework('${s.id}')" ${!canEdit?'disabled':''} class="w-8 h-8 rounded-full shadow transition ${hwClass}"><i class="fas fa-home"></i></button></td><td class="px-2 py-3 text-center"><select onchange="updateBehavior('${s.id}', this.value)" ${!canEdit?'disabled':''} class="border rounded text-xs p-1 font-bold"><option ${todayLog.behavior==='Normal'?'selected':''}>Normal</option><option ${todayLog.behavior==='Excelente'?'selected':''}>Excelente</option><option ${todayLog.behavior==='Conversou'?'selected':''}>Conversou</option><option ${todayLog.behavior==='Ruim'?'selected':''}>Ruim</option></select></td></tr>`;
            });
            tbody.innerHTML = html;
        }

        // --- LOGIC HELPERS ---
        function toggleAttendance(id) {
            let curr = tempAttendance[id];
            let status = typeof curr === 'string' ? curr : curr.status;
            tempAttendance[id] = status === 'P' ? { status: 'F', justified: false, doc: null } : 'P';
            renderAttendanceTable();
        }
        function toggleHomework(id) { tempDaily[id].homework = !tempDaily[id].homework; renderDailyLog(); }
        function updateBehavior(id, val) { tempDaily[id].behavior = val; }
        
        async function saveDailyAttendance() {
            const date = document.getElementById('attendance-date').value;
            let batch = db.batch();
            appData.students.forEach(s => { if(s.class === appData.currentClass) {
                const sd = ensureSubjectData(s, appData.currentSubject); sd.attendance[date] = tempAttendance[s.id];
                batch.update(db.collection('concenal_students').doc(s.id), { [`subjects.${appData.currentSubject}.attendance`]: sd.attendance });
            }});
            await batch.commit(); alert("Frequência salva!");
        }
        async function saveDailyLog() {
            const date = document.getElementById('daily-date').value;
            let batch = db.batch();
            appData.students.forEach(s => { if(s.class === appData.currentClass) {
                const sd = ensureSubjectData(s, appData.currentSubject); if(!sd.dailyLogs) sd.dailyLogs={}; sd.dailyLogs[date] = tempDaily[s.id];
                batch.update(db.collection('concenal_students').doc(s.id), { [`subjects.${appData.currentSubject}.dailyLogs`]: sd.dailyLogs });
            }});
            await batch.commit(); alert("Diário salvo!");
        }

        // --- SHARED ---
        function switchMode(m) { appData.currentMode = m; updateUI(); }
        function changeSubject(v) { if(currentUser.role!=='parent') { appData.currentSubject=v; updateUI(); } }
        function renderClassTabs() {
            const c = document.getElementById('class-tabs'); c.innerHTML='';
            if(currentUser.role === 'parent') return;
            appData.classes.forEach(cls => {
                const btn = document.createElement('button');
                btn.className = `px-3 py-1 rounded text-sm whitespace-nowrap border ${appData.currentClass===cls ? 'bg-school-green text-white' : 'bg-white'}`;
                btn.innerText = cls; btn.onclick = () => { appData.currentClass=cls; updateUI(); };
                c.appendChild(btn);
            });
        }
        function ensureSubjectData(s, subj) { 
            if(!s.subjects) s.subjects = {};
            if(!s.subjects[subj]) {
                s.subjects[subj] = { 
                    units: [null,null,null,null,null,null], 
                    attendance: {}, 
                    dailyLogs: {}, 
                    observation: "" 
                };
            } else {
                // Migração/Garantia de integridade para dados existentes
                if(!s.subjects[subj].units) s.subjects[subj].units = [null,null,null,null,null,null];
                if(!s.subjects[subj].attendance) s.subjects[subj].attendance = {};
                if(!s.subjects[subj].dailyLogs) s.subjects[subj].dailyLogs = {};
                if(typeof s.subjects[subj].observation === 'undefined') s.subjects[subj].observation = "";
            }
            return s.subjects[subj]; 
        }
        function calculateStatus(subData) {
            let sum=0; subData.units.forEach(u => { if(u) sum+=parseFloat(u) });
            let avg = (sum/6).toFixed(1);
            let st = "Cursando", cl = "text-gray-500", final = avg;
            if (avg < 6.0) {
                if (subData.recovery !== null && subData.recovery !== "") {
                    final = (parseFloat(avg) + parseFloat(subData.recovery)) / 2;
                    st = final >= 6.0 ? "Aprovado (Rec)" : "Reprovado"; cl = final >= 6.0 ? "text-green-600" : "text-red-600";
                } else { st = "Recuperação"; cl = "text-orange-500"; }
            } else { st = "Aprovado"; cl = "text-green-600"; }
            return { average: avg, status: st, statusClass: cl };
        }
        function updateGrade(id, idx, val) { const s = appData.students.find(st => st.id === id); const sd = ensureSubjectData(s, appData.currentSubject); sd.units[idx] = val; db.collection('concenal_students').doc(s.id).update({ [`subjects.${appData.currentSubject}.units`]: sd.units }); }
        function updateRecovery(id, val) { const s = appData.students.find(st => st.id === id); db.collection('concenal_students').doc(s.id).update({ [`subjects.${appData.currentSubject}.recovery`]: val }); }
        function addStudent() { const n = document.getElementById('new-name').value; db.collection('concenal_students').add({ name: n, class: appData.currentClass, subjects: {} }); closeModal('modal-add'); }
        async function importStudents() {
            const list = document.getElementById('import-list').value.split('\n');
            let batch = db.batch();
            list.forEach(name => {
                if(name.trim()) {
                    const ref = db.collection('concenal_students').doc();
                    batch.set(ref, { name: name.trim(), class: appData.currentClass, subjects: {} });
                }
            });
            await batch.commit();
            closeModal('modal-import');
            alert("Importação concluída!");
        }
        function deleteStudent(id) { if(confirm("Excluir?")) db.collection('concenal_students').doc(id).delete(); }
        function getStudentsByClass() { return appData.students.filter(s => s.class === appData.currentClass).sort((a,b)=>a.name.localeCompare(b.name)); }
        function populateSubjectSelect() { const sel = document.getElementById('subject-select'); sel.innerHTML = SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join(''); }
        function populateNewUserSubjectSelect() { const sel = document.getElementById('new-u-subject'); sel.innerHTML = SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join(''); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openAddModal() { document.getElementById('modal-add').classList.remove('hidden'); }
        
        // --- RELATÓRIO CORRIGIDO ---
        function openReportModal(id) { 
            currentStudentForReport=appData.students.find(s=>s.id===id); 
            if(!currentStudentForReport) return alert("Erro ao abrir aluno.");
            
            const subData = ensureSubjectData(currentStudentForReport, appData.currentSubject);
            const calc = calculateStatus(subData);
            const totalFaults = Object.values(subData.attendance || {}).filter(val => {
                if (val === 'F') return true;
                if (typeof val === 'object' && val.status === 'F' && !val.justified) return true;
                return false;
            }).length;

            document.getElementById('report-name').innerText = currentStudentForReport.name;
            document.getElementById('report-avg').innerText = calc.average;
            document.getElementById('report-faults').innerText = totalFaults;
            document.getElementById('report-status').innerText = calc.status;
            
            const obsField = document.getElementById('report-observation');
            obsField.value = subData.observation || "";
            
            const tools = document.getElementById('report-tools');
            if (currentUser.role === 'parent') {
                tools.classList.add('hidden');
                obsField.disabled = true;
                if(!obsField.value) obsField.value = "Nenhuma análise pedagógica disponível.";
            } else {
                tools.classList.remove('hidden');
                obsField.disabled = false;
                obsField.placeholder = "Escreva ou gere com IA a análise pedagógica...";
            }

            document.getElementById('modal-report').classList.remove('hidden'); 
        }
        function saveReportObservation() {
            const val = document.getElementById('report-observation').value;
            const s = currentStudentForReport;
            db.collection('concenal_students').doc(s.id).update({ [`subjects.${appData.currentSubject}.observation`]: val })
            .then(() => alert("Parecer salvo com sucesso!"));
        }
        function showHistory(id) { alert("Histórico disponível no relatório completo."); }
        
        // --- USERS & GESTÃO (Descompactado) ---
        function openJustifyModal(sid) { 
            currentJustificationStudentId=sid; 
            currentJustificationDate=document.getElementById('attendance-date').value; 
            document.getElementById('just-date-display').innerText=`Data: ${currentJustificationDate}`; 
            document.getElementById('modal-justification').classList.remove('hidden'); 
        }
        function compressImage(file, callback) { 
            const r = new FileReader(); 
            r.readAsDataURL(file); 
            r.onload=e=>{ 
                const i=new Image(); 
                i.src=e.target.result; 
                i.onload=()=>{ 
                    const c=document.createElement('canvas'); 
                    const scale=400/Math.max(i.width,i.height); 
                    c.width=i.width*scale; 
                    c.height=i.height*scale; 
                    c.getContext('2d').drawImage(i,0,0,c.width,c.height); 
                    callback(c.toDataURL('image/jpeg',0.7)); 
                }
            }; 
        }
        async function submitJustification() { 
            const r=document.getElementById('just-reason').value; 
            const f=document.getElementById('just-file').files[0]; 
            const save=(b64)=>{ 
                const s=appData.students.find(st=>st.id===currentJustificationStudentId); 
                const sd=ensureSubjectData(s, appData.currentSubject); 
                sd.attendance[currentJustificationDate]={status:'F',justified:true,reason:r,doc:b64}; 
                db.collection('concenal_students').doc(s.id).update({[`subjects.${appData.currentSubject}.attendance`]:sd.attendance}); 
                closeModal('modal-justification'); 
                alert("Enviado!"); 
                renderAttendanceTable(); 
            }; 
            if(f) compressImage(f,save); else save(null); 
        }
        function viewDoc(sid, d) { 
            const s=appData.students.find(st=>st.id===sid); 
            const r=s.subjects[appData.currentSubject].attendance[d]; 
            if(r&&r.doc) { const w=window.open(""); w.document.write(`<img src="${r.doc}" style="max-width:100%">`); } 
        }
        function openUsersModal(){ 
            document.getElementById('modal-users').classList.remove('hidden'); 
            switchUserTab('teacher'); 
        }
        function switchUserTab(t){ 
            creatingUserType=t; 
            document.getElementById('tab-teacher').className=t==='teacher'?"px-3 py-1 font-bold text-sm border-b-2 border-school-green text-school-green":"px-3 py-1 font-bold text-sm text-gray-500"; 
            document.getElementById('tab-parent').className=t==='parent'?"px-3 py-1 font-bold text-sm border-b-2 border-school-green text-school-green":"px-3 py-1 font-bold text-sm text-gray-500"; 
            document.getElementById('field-teacher-subj').classList.toggle('hidden',t!=='teacher'); 
            document.getElementById('field-parent-student').classList.toggle('hidden',t!=='parent'); 
            loadUsersList(); 
        }
        async function createUser() { 
            const n=document.getElementById('new-u-name').value; 
            const l=document.getElementById('new-u-login').value; 
            const p=document.getElementById('new-u-pass').value; 
            let ex={role:creatingUserType}; 
            if(creatingUserType==='teacher') ex.subject=document.getElementById('new-u-subject').value; 
            else ex.studentId=document.getElementById('new-u-student-id').value; 
            if(!n||!l||!p) return alert("Preencha tudo"); 
            await db.collection('concenal_users').add({name:n,username:l,password:p,...ex}); 
            alert("Criado!"); 
            loadUsersList(); 
        }
        function loadUsersList() { 
            const d=document.getElementById('users-list'); 
            d.innerHTML='...'; 
            db.collection('concenal_users').where('role','==',creatingUserType).get().then(s=>{ 
                d.innerHTML=''; 
                s.forEach(doc=>{ 
                    const da=doc.data(); 
                    d.innerHTML+=`<div class="flex justify-between p-2 bg-gray-50 mb-1 rounded border"><div><b>${da.name}</b> (${da.username})</div><button onclick="db.collection('concenal_users').doc('${doc.id}').delete().then(loadUsersList)" class="text-red-500"><i class="fas fa-trash"></i></button></div>`; 
                }); 
            }); 
        }

        init();
    </script>
    
    <!-- Modal Aux -->
    <div id="modal-add" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4"><div class="bg-white rounded p-6 w-full max-w-sm"><h3 class="font-bold mb-4">Adicionar Aluno</h3><input id="new-name" class="border w-full p-2 mb-4 rounded" placeholder="Nome"><div class="flex justify-end gap-2"><button onclick="closeModal('modal-add')" class="bg-gray-200 px-4 py-2 rounded">Cancelar</button><button onclick="addStudent()" class="bg-school-green text-white px-4 py-2 rounded">Salvar</button></div></div></div>

</body>
</html>
